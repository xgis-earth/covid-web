# 2019-nCoV Website

[![Build Status](https://drone.tiepy.com/api/badges/xgis-earth/covid-web/status.svg)](
https://drone.tiepy.com/xgis-earth/covid-web)

## Development Notes

The following environment variables must be defined for webpack:

* `COVID_HASURA_DOMAIN`
* `COVID_ION_TOKEN`
* `COVID_MAPBOX_TOKEN`

## Database & Kubernetes Deployment

The API in this application is provided by Hasura, on top of a Postgres database.
The API is hosted in Kubernetes.

Kubernetes is used to manage the additional services provided through Hasura.
Events are used to update data from multiple sources.
Actions are used to extend the API generated by Hasura from the database schema.

More detail on the Kubernetes setup is not currently provided here. 

### Database Snapshot

A snapshot of the database is provided in this repository.
See `db_snapshot.7z` in repository root.

## Hasura Deployment

Hasura is deployed using the following Kubernetes template:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: hasura
    hasuraService: custom
  name: hasura
  namespace: covid
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: hasura
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: hasura
    spec:
      containers:
      - image: hasura/graphql-engine:v1.3.3
        imagePullPolicy: IfNotPresent
        name: hasura
        env:
        - name: HASURA_GRAPHQL_DATABASE_URL
          value: postgres://<username>:<password>@<host>/<dbname>?sslmode=require
        - name: HASURA_GRAPHQL_ADMIN_SECRET
          value: <admin_secret>
        - name: HASURA_GRAPHQL_JWT_SECRET
          value: '{"type": "HS256", "key": "<jwt_secret>", "audience": "hasura", "issuer": "covid"}'
        ## enable the console served by server
        - name: HASURA_GRAPHQL_ENABLE_CONSOLE
          value: "true"
        ## enable debugging mode. It is recommended to disable this in production
        - name: HASURA_GRAPHQL_DEV_MODE
          value: "false"
        - name: HASURA_GRAPHQL_PG_CONNECTIONS
          value: "40"
        - name: HASURA_GRAPHQL_ENABLE_TELEMETRY
          value: "false"
        - name: HASURA_GRAPHQL_UNAUTHORIZED_ROLE
          value: "public"
        ports:
        - containerPort: 8080
          protocol: TCP
        resources: {}
```

Database details and other secrets to be inserted above.

Hasura is deployed to Kubernetes and the API service exposed using the following commands:

```bash
kubectl apply -f api-deployment.yaml -n=covid
kubectl expose deployment/hasura -n=covid
```

### Event & Action Deployments

Additional repositories are available for the deployments below.

#### Events

Cron triggers registered for the following:

* [refresh-johns-hopkins-data](https://github.com/xgis-earth/covid-refresh-johns-hopkins-data)
* [refresh-owid-data](https://github.com/xgis-earth/covid-refresh-owid-data)
* [refresh-population-counts](https://github.com/xgis-earth/covid-refresh-population-counts)
* [refresh-test-counts](https://github.com/xgis-earth/covid-refresh-test-counts)

#### Actions

* [country_airline_info](https://github.com/xgis-earth/action-query-country-airline-info)
* [country_news](https://github.com/xgis-earth/action-query-country-news)
* [country_travel_info](https://github.com/xgis-earth/action-query-country-travel-info)
